<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-app.js"></script>

        <!-- TODO: Add SDKs for Firebase products that you want to use
            https://firebase.google.com/docs/web/setup#available-libraries -->
        <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-analytics.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-messaging.js"></script>

        <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
            apiKey: "AIzaSyC4QaRTTd-ZokKkRNC7Jn5ivBMMJqBCNIk",
            authDomain: "housecall-5f6bd.firebaseapp.com",
            projectId: "housecall-5f6bd",
            storageBucket: "housecall-5f6bd.appspot.com",
            messagingSenderId: "1076373306124",
            appId: "1:1076373306124:web:96d26e5d04389346e16729",
            measurementId: "G-2GSLVPC3CX"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

        const messaging = firebase.messaging();
        messaging.requestPermission()
        .then(() => {
            messaging.getToken({vapidKey: "BEOpflDaUQ-BB1LuPsEF_1KWLcehT8UnaiVw58YHhtTcbd0kLAQljFwaYAb7q4d8_cFVayBRrjcZPKByAXylV08"})
            .then((token) => {
                console.log(token);
                subscribeToTopic(token)
            })
            .catch((err) => {
                console.log(err);
            })
        })
        messaging.onMessage((payload) => {
            console.log("foreground", payload);
        })

        function subscribeToTopic(token){
            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200){
                    console.log(xhttp.responseText);
                }
            }
            xhttp.open("POST", "https://whsfkf8zibahncto.myfritz.net/housecall/subscribetotopic", true);
            xhttp.setRequestHeader("Content-Type", "application/json");
            xhttp.send(JSON.stringify({"token": token, "topic": "test"}));
        }
        </script>
    </body>
</html>
